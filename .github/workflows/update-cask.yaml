name: Update Cask Formula

on:
  repository_dispatch:
    types: [update-cask]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (without v prefix)'
        required: true
      sha256:
        description: 'SHA256 of the darwin_aarch64.dmg'
        required: true

jobs:
  # Step 1: Update cask file and push branch
  update-cask:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.params.outputs.version }}
      sha256: ${{ steps.params.outputs.sha256 }}
      changed: ${{ steps.diff.outputs.changed }}
      branch: ${{ steps.branch.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version and sha256
        id: params
        env:
          DISPATCH_VERSION: ${{ github.event.client_payload.version }}
          DISPATCH_SHA256: ${{ github.event.client_payload.sha256 }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_SHA256: ${{ github.event.inputs.sha256 }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "repository_dispatch" ]; then
            VERSION="$DISPATCH_VERSION"
            SHA256="$DISPATCH_SHA256"
          else
            VERSION="$INPUT_VERSION"
            SHA256="$INPUT_SHA256"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Updating to version: $VERSION"
          echo "SHA256: $SHA256"

      - name: Update Cask formula
        env:
          VERSION: ${{ steps.params.outputs.version }}
          SHA256: ${{ steps.params.outputs.sha256 }}
        run: |
          sed -i "s/version \".*\"/version \"${VERSION}\"/" Casks/kunobi.rb
          sed -i "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/kunobi.rb
          echo "Updated Casks/kunobi.rb:"
          cat Casks/kunobi.rb

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet Casks/kunobi.rb; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Cask already up to date, skipping"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Push update branch
        if: steps.diff.outputs.changed == 'true'
        id: branch
        env:
          VERSION: ${{ steps.params.outputs.version }}
        run: |
          BRANCH="update-${VERSION}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add Casks/kunobi.rb
          git commit -m "Update Kunobi to v${VERSION}"
          git push --force-with-lease origin "$BRANCH"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT

  # Step 2: Validate the updated cask (download DMG, verify SHA256)
  validate:
    needs: update-cask
    if: needs.update-cask.outputs.changed == 'true'
    uses: ./.github/workflows/validate-cask.yaml
    with:
      ref: ${{ needs.update-cask.outputs.branch }}

  # Step 3: Create PR only if validation passes
  create-pr:
    needs: [update-cask, validate]
    if: needs.update-cask.outputs.changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.update-cask.outputs.version }}
          SHA256: ${{ needs.update-cask.outputs.sha256 }}
          BRANCH: ${{ needs.update-cask.outputs.branch }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          gh pr create \
            --repo "$GITHUB_REPOSITORY" \
            --head "$BRANCH" \
            --base main \
            --title "Update Kunobi to v${VERSION}" \
            --body "$(cat <<EOF
          > ðŸ¤– Auto-generated and validated by [update-cask](${RUN_URL}) workflow

          - **Version**: \`${VERSION}\`
          - **SHA256**: \`${SHA256}\`
          - **DMG checksum**: âœ… Verified
          EOF
          )"
